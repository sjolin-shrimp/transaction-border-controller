Great ‚Äî now that the architecture is crystal-clear (Client Runtime separate from Wallet; wallet as a blind signer; browser extension as the primary distribution layer), we can produce clean, formal draft specifications.

Below are first-pass, high-clarity drafts for:

‚∏ª

üìò TGP-CP-00 ‚Äî Transaction Gateway Protocol: Client Profile

Version: 0.1-draft
Status: Draft
Audience: Client Runtime Implementers (browser extension, wallet-native client modules, headless agent runtimes)
Scope: Defines how a Client interacts with TGP, TBC, x402 signals, and the escrow settlement layer.

‚∏ª

1. Purpose

The TGP Client Profile (TGP-CP-00) specifies:
	‚Ä¢	how Clients interpret TGP envelopes
	‚Ä¢	how Clients respond to x402 payment_required messages
	‚Ä¢	how Clients perform TGP queries to a Transaction Border Controller (TBC)
	‚Ä¢	how Clients construct transactions using the TBC ACK
	‚Ä¢	how Clients route signed transactions to RPC or to the TBC

This profile allows safe, compliant, multi-step, multi-chain economic transactions, without requiring modification to wallet key generation, signing engines, or blockchain RPC standards.

‚∏ª

2. Client Responsibilities (Summary)

A TGP Client MUST:
	1.	Detect x402 Payment Required messages
	2.	Parse the TGP envelope (if present) or construct one
	3.	Send a TGP QUERY to the TBC
	4.	Receive TGP ACK containing:
	‚Ä¢	transaction construction parameters
	‚Ä¢	escrow verb
	‚Ä¢	session rules
	‚Ä¢	routing instructions
	5.	Construct a standard blockchain transaction payload
	6.	Present transaction to the wallet for signing (unchanged EVM/SVM UX)
	7.	Route the signed transaction as directed (RPC or TBC relay)
	8.	Handle multi-step escrow verbs (commit ‚Üí fulfill ‚Üí claim‚Ä¶) by looping
	9.	Optionally display session/receipt metadata to the user

A TGP Client MUST NOT:
	‚Ä¢	generate or manage private keys
	‚Ä¢	alter wallet signing logic
	‚Ä¢	inject scripts into wallet popups
	‚Ä¢	broadcast unsigned transactions
	‚Ä¢	circumvent the TBC

A Client MAY:
	‚Ä¢	integrate with wallets through wallet APIs
	‚Ä¢	support agent-driven autonomous execution with user authorization
	‚Ä¢	store TGP session metadata locally
	‚Ä¢	expose UX enhancements

‚∏ª

3. Triggering Events

A Client MUST activate TGP processing upon one of:

3.1. x402 payment_required

Received from:
	‚Ä¢	dApp
	‚Ä¢	merchant endpoint
	‚Ä¢	AI agent
	‚Ä¢	API callback

3.2. Explicit user request

User clicks:
	‚Ä¢	‚ÄúPay‚Äù
	‚Ä¢	‚ÄúFulfill order‚Äù
	‚Ä¢	‚ÄúContinue‚Äù
	‚Ä¢	etc.

3.3. TGP session continuation

When processing multi-verb flows:
	‚Ä¢	commit ‚Üí accept ‚Üí fulfill ‚Üí claim
	‚Ä¢	or time-based follow-ups

‚∏ª

4. TGP QUERY Format (Client ‚Üí TBC)

A Client must send:

{
  "session_id": <uuid or null>,
  "payment_profile": <contract address>,
  "chain_id": <int>,
  "buyer_address": <string>,
  "amount": <bigint>,
  "tgp_version": "0.1",
  "intent": {
      "verb": "commit" | "pay" | "quote" | etc.
  },
  "metadata": { ... x402 fields ... }
}

The Client MUST include:
	‚Ä¢	buyer address
	‚Ä¢	payment profile address
	‚Ä¢	chain ID
	‚Ä¢	transaction amount
	‚Ä¢	the current escrow verb

‚∏ª

5. TGP ACK Format (TBC ‚Üí Client)

The TBC responds:

{
  "status": "allow" | "deny" | "revise",
  "session_id": <id>,
  "next_verb": <verb>,
  "tx": {
      "to": <contract address>,
      "value": <bigint>,
      "data": <hex>,
      "chain_id": <int>,
      "gas_limit": <int optional>,
      "gas_price": <optional>
  },
  "routing": {
      "mode": "direct" | "relay",
      "rpc_url": <string if direct>,
      "tbc_url": <string if relay>
  },
  "timeouts": {
      "fulfillment_window": <ms>,
      "session_expiry": <ms>
  },
  "receipt_hint": <optional>,
  "notes": <optional>
}

The Client MUST obey:
	‚Ä¢	status
	‚Ä¢	next_verb
	‚Ä¢	tx construction
	‚Ä¢	routing

‚∏ª

6. Transaction Construction

The Client MUST:
	1.	Use the tx fields verbatim
	2.	NOT modify calldata
	3.	NOT alter destination
	4.	NOT alter chain ID
	5.	Present transaction to wallet as a standard signing request

Wallet remains unaware that this is a TGP-driven flow.

‚∏ª

7. Transaction Signing (Client ‚Üí Wallet)

A Client MUST:
	‚Ä¢	call the wallet‚Äôs standard API (EIP-1193 or similar)
	‚Ä¢	display the standard wallet popup
	‚Ä¢	NOT bypass user approval

Wallet signs normally.

‚∏ª

8. Transaction Routing (Client ‚Üí RPC or TBC)

If "routing.mode" == "direct"

Client broadcasts the signed tx to the RPC.

If "relay"

Client POSTs:

{
  "session_id": ...,
  "signed_tx": <hex>,
}

to the TBC.

‚∏ª

9. Escrow Verb Looping

If next_verb != "claim":

Client MUST re-enter Step 3.
(TGP QUERY ‚Üí ACK ‚Üí TX ‚Üí sign ‚Üí send)

‚∏ª

10. Receipts and Storage

Client MAY store:
	‚Ä¢	session ID
	‚Ä¢	receipt hash
	‚Ä¢	TBC policy hash
	‚Ä¢	merchant metadata

Client MUST NEVER store:
	‚Ä¢	private keys
	‚Ä¢	cleartext wallet addresses beyond normal use

‚∏ª

END OF TGP-CP-00 (first draft)

‚∏ª

‚∏ª

üìó TGP-EX-00 ‚Äî Transaction Gateway Protocol: Browser Extension Runtime

Version: 0.1-draft
Status: Draft
Audience: Extension developers (Chrome MV3, Firefox, Brave, Safari)
Purpose: Defines how a browser extension implements TGP-CP-00 in a compliant, safe, non-custodial manner that passes browser store security requirements.

‚∏ª

1. Purpose & Model

The TGP Extension is the default and recommended Client implementation.

It:
	‚Ä¢	receives x402 signals
	‚Ä¢	parses TGP envelopes
	‚Ä¢	communicates with the user‚Äôs TBC
	‚Ä¢	constructs transactions
	‚Ä¢	forwards them to wallets for signing
	‚Ä¢	routes signed transactions

The extension MUST be:
	‚Ä¢	permission-minimal
	‚Ä¢	non-custodial
	‚Ä¢	non-injective into password or key fields
	‚Ä¢	compliant with Chrome MV3, Safari WKWebExtension, and Firefox standards
	‚Ä¢	secure and transparent

‚∏ª

2. Extension Architecture

Components:
	1.	Background Service Worker (MV3)
	‚Ä¢	short-lived
	‚Ä¢	event-driven
	‚Ä¢	handles TGP queries, TBC calls, transaction routing
	2.	Content Script (optional)
	‚Ä¢	listens for x402 messages emitted by dApps or agents
	‚Ä¢	MUST NOT read sensitive fields
	‚Ä¢	MUST NOT access secure iframes
	3.	UI Panel / Popup
	‚Ä¢	displays TGP status: ‚ÄúTGP Present‚Äù, session info, TBC status
	4.	Local Storage
	‚Ä¢	stores session metadata (non-sensitive)
	‚Ä¢	MUST NOT store private keys
	5.	RPC Module
	‚Ä¢	handles direct transaction submission

‚∏ª

3. Permissions

The extension MUST NOT request unnecessary permissions.

Allowed:
	‚Ä¢	activeTab
	‚Ä¢	storage
	‚Ä¢	scripting
	‚Ä¢	notifications
	‚Ä¢	fetch
	‚Ä¢	host permissions limited to user-provided TBC endpoint
	‚Ä¢	optional dApp pages where x402 messages reside

Forbidden:
	‚Ä¢	clipboardRead
	‚Ä¢	clipboardWrite
	‚Ä¢	webRequestBlocking
	‚Ä¢	intercepting wallet popups
	‚Ä¢	keylogging or DOM scraping

‚∏ª

4. Extension Event Flow
	1.	Receive payment_required from a content script bridge
	2.	Construct TGP envelope
	3.	Background worker sends QUERY ‚Üí TBC
	4.	TBC sends ACK
	5.	Background worker builds raw TX
	6.	Extension popup asks user: ‚ÄúProceed with TGP session?‚Äù
	7.	TX forwarded to wallet (EIP-1193)
	8.	Wallet signs
	9.	Background worker routes signed tx
	10.	Extension logs session + receipt metadata

‚∏ª

5. TBC Communication Requirements

Extension MUST:
	‚Ä¢	use HTTPS
	‚Ä¢	validate certificates
	‚Ä¢	only communicate with user-configured endpoints
	‚Ä¢	handle timeouts gracefully
	‚Ä¢	use short-lived fetch() calls

Extension MUST NOT:
	‚Ä¢	maintain persistent WebSocket connections unless user explicitly enables ‚ÄúAgent Mode‚Äù
	‚Ä¢	beacon to third-party servers

‚∏ª

6. Security Requirements

Extension MUST NOT:
	‚Ä¢	request seed words
	‚Ä¢	handle private keys
	‚Ä¢	persist sensitive transaction data
	‚Ä¢	alter wallet signing flows
	‚Ä¢	fake transaction confirmations
	‚Ä¢	intercept wallet popups

Extension MUST:
	‚Ä¢	be open source (recommended but not required)
	‚Ä¢	clearly disclose all network endpoints
	‚Ä¢	support isolated worlds (content scripts cannot access page JS directly)

‚∏ª

7. Wallet Interaction

Extension MUST:
	‚Ä¢	detect wallet presence
	‚Ä¢	send standard transaction requests via EIP-1193
	‚Ä¢	never bypass user approval

Extension MAY:
	‚Ä¢	display a ‚ÄúTGP NAT Present‚Äù signal inside the extension popup
	‚Ä¢	expose session info to the wallet via custom events (optional)

‚∏ª

8. Compliance Across Browsers

Chrome MV3
	‚Ä¢	use Service Worker
	‚Ä¢	no persistent background scripts

Firefox
	‚Ä¢	may allow background pages
	‚Ä¢	same security rules

Safari
	‚Ä¢	WKWebExtension; permissions heavily restricted
	‚Ä¢	must avoid injected scripts that read sensitive fields
